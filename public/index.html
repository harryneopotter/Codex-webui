<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Codex WebUI</title>
    <style>
      :root { --bg:#0b0b0c; --panel:#0f1014; --panel2:#111216; --border:#23242a; --text:#eaeaea; --muted:#9aa0a6; --btn:#1a1b22; --btnb:#2a2b32; --accent:#2b6ef6; }
      body.light { --bg:#f6f8fb; --panel:#ffffff; --panel2:#eef1f6; --border:#d5d9e2; --text:#0b0b0c; --muted:#6b7280; --btn:#ffffff; --btnb:#cfd4dd; --accent:#2b6ef6; }
      html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100%; }
      .wrap { display: flex; flex-direction: column; height: 100vh; opacity:0; transform: translateY(4px); transition: opacity .22s ease, transform .22s ease; }
      body.ready .wrap { opacity:1; transform: translateY(0); }
      header { padding: 12px 16px; background: var(--panel2); border-bottom: 1px solid var(--border); font-weight: 600; display:flex; align-items:center; justify-content:space-between; }
      header .stats { font-weight: 500; opacity:.85; font-size: 13px; }
      .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; background:#999; box-shadow: 0 0 0 1px rgba(0,0,0,.2) inset; vertical-align:middle; }
      .dot.ok { background:#22c55e; }
      .dot.warn { background:#f59e0b; }
      .dot.err { background:#ef4444; }
      .layout { display: flex; flex: 1; min-height: 0; }
      .sidebar { width: 320px; border-right: 1px solid var(--border); background: var(--panel); display: flex; flex-direction: column; transition: width .22s ease; }
      .sidebar.expanded { width: 320px; }
      .sidebar.collapsed { width: 48px; }
      .sidehead { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--border); }
      .sbody { flex: 1; overflow: auto; padding: 10px 12px; transition: opacity .18s ease; }
      .sidebar.collapsed .sbody { opacity: 0; pointer-events: none; }
      .section { margin-bottom: 16px; }
      .section h3 { margin: 8px 0; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; display:flex; align-items:center; gap:6px; }
      .section h3 svg { width:16px; height:16px; }
      .list a { display:block; padding:6px 8px; border:1px solid var(--border); border-radius:6px; margin:6px 0; color:var(--text); text-decoration:none; background:var(--bg); }
      .list a small { display:block; color:var(--muted); }
      .nav-icons { display: none; flex-direction: column; gap: 8px; padding: 8px; }
      .nav-icons button { background:var(--btn); color:var(--text); border:1px solid var(--btnb); border-radius:6px; padding:8px 0; cursor:pointer; font-size:16px; width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; }
      .sidebar.collapsed .nav-icons { display: flex; }
      .content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
      .toolbar { display:flex; gap:8px; align-items:center; padding:8px; border-bottom:1px solid var(--border); background:var(--panel); }
      .toolbar button { background:var(--btn); color:var(--text); border:1px solid var(--btnb); border-radius:6px; padding:6px 10px; cursor:pointer; }
      .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity .18s ease; }
      .modal.open { display: flex; opacity: 1; }
      .dialog { background: var(--panel); border: 1px solid var(--btnb); border-radius: 8px; padding: 16px; width: 420px; max-width: 90vw; transform: translateY(8px); opacity: 0; transition: transform .2s ease, opacity .2s ease; }
      .modal.open .dialog { transform: translateY(0); opacity: 1; }
      .dialog h4 { margin: 0 0 8px; }
      .dialog p { margin: 0 0 14px; color: #c7c7c7; }
      .dialog .actions { display:flex; gap:10px; justify-content: flex-end; }
      .dialog button { padding: 8px 12px; border-radius: 6px; border:1px solid var(--btnb); background:var(--btn); color:var(--text); cursor:pointer; }
      #log { flex: 1; overflow: auto; padding: 16px; line-height: 1.45; }
      .sys { color: #8ab4f8; }
      .err { color: #ff6b6b; }
      .tool { color: #f5c542; }
      .msg { white-space: pre-wrap; }
      .input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--border); background: var(--panel2); }
      .input textarea { flex: 1; min-height: 48px; max-height: 160px; resize: vertical; background: var(--panel); color: var(--text); border: 1px solid var(--btnb); border-radius: 6px; padding: 8px; }
      .input button { background: var(--accent); color: white; border: 0; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; }
      .bubble { margin: 8px 0; padding: 8px 10px; border-radius: 6px; }
      .from-user { background: var(--btn); border: 1px solid var(--btnb); }
      .from-agent { background: var(--panel); border: 1px solid var(--border); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 0.95em; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div><span id="connDot" class="dot warn"></span>Codex WebUI</div>
        <button id="themeToggleHeader" title="Toggle theme" style="background:transparent; border:0; cursor:pointer; width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; color:var(--text);">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.5A9 9 0 1 1 11.5 3 7 7 0 0 0 21 12.5z" stroke="currentColor" stroke-width="1.6"/></svg>
        </button>
      </header>
      <div class="layout">
        <aside id="sidebar" class="sidebar expanded">
          <div class="sidehead">
            <strong style="display:flex; align-items:center; gap:8px;">
              <button id="navToggle" title="Collapse/Expand" style="width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center; border:1px solid var(--btnb); border-radius:6px; background:var(--btn); color:var(--text); cursor:pointer;">☰</button>
              Navigator
            </strong>
          </div>
          <div class="nav-icons">
            <button id="icoSessions" title="Sessions">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.6"/><path d="M8 7V5a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="1.6"/></svg>
            </button>
            <button id="icoProjects" title="Projects">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h6l2 2h10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.6"/></svg>
            </button>
            <button id="icoMemory" title="Memories">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 4c4.5 0 7 2.6 7 6 0 2-1 3.5-2.6 4.5.1.4.1.8.1 1.2 0 1.3-1 2.3-2.3 2.3-.4 0-.8-.1-1.1-.3-.7.7-1.7 1.1-2.8 1.1-2.2 0-4-1.8-4-4 0-.5.1-1 .3-1.5C5.1 12.3 4 10.9 4 10c0-3.4 2.5-6 8-6z" stroke="currentColor" stroke-width="1.6"/></svg>
            </button>
            <button id="icoSettings" title="Settings">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.6"/><path d="M19.4 15a7.8 7.8 0 0 0 .1-6l1.8-1.1-2-3.4-2 .7a8 8 0 0 0-5.1-2l-.6-2.2H10l-.6 2.2a8 8 0 0 0-5.1 2l-2-.7-2 3.4L2 9a7.8 7.8 0 0 0 .1 6l-1.8 1.1 2 3.4 2-.7a8 8 0 0 0 5.1 2l.6 2.2h2.4l.6-2.2a8 8 0 0 0 5.1-2l2 .7 2-3.4-1.8-1.1z" stroke="currentColor" stroke-width="1.0" opacity=".35"/></svg>
            </button>
          </div>
          <div class="sbody">
            <div class="section">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 7h16v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.6"/><path d="M8 7V5a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2" stroke="currentColor" stroke-width="1.6"/></svg>
                Sessions
              </h3>
              <div id="sessions" class="list"></div>
            </div>
            <div class="section">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h6l2 2h10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.6"/></svg>
                Projects
              </h3>
              <div id="projects" class="list"></div>
            </div>
            <div class="section">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 4c4.5 0 7 2.6 7 6 0 2-1 3.5-2.6 4.5.1.4.1.8.1 1.2 0 1.3-1 2.3-2.3 2.3-.4 0-.8-.1-1.1-.3-.7.7-1.7 1.1-2.8 1.1-2.2 0-4-1.8-4-4 0-.5.1-1 .3-1.5C5.1 12.3 4 10.9 4 10c0-3.4 2.5-6 8-6z" stroke="currentColor" stroke-width="1.6"/></svg>
                Memory
              </h3>
              <div class="list"><a href="#" id="showMemories">Show memories</a></div>
            </div>
            <div class="section">
              <h3>
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="1.6"/><path d="M19.4 15a7.8 7.8 0 0 0 .1-6l1.8-1.1-2-3.4-2 .7a8 8 0 0 0-5.1-2l-.6-2.2H10l-.6 2.2a8 8 0 0 0 5.1 2l-2-.7-2 3.4L2 9a7.8 7.8 0 0 0 .1 6l-1.8 1.1 2 3.4 2-.7a8 8 0 0 0 5.1 2l.6 2.2h2.4l.6-2.2a8 8 0 0 0 5.1-2l2 .7 2-3.4-1.8-1.1z" stroke="currentColor" stroke-width="1.0" opacity=".35"/></svg>
                Settings
              </h3>
              <div class="list"><a href="#" id="openSettings">Open settings</a></div>
            </div>
          </div>
        </aside>
        <main class="content">
          <div class="toolbar">
            <button id="openMemoryTop">Memory</button>
            <div id="status" class="mono" style="opacity:.85"></div>
          </div>
          <div id="log"></div>
          <div class="input">
            <textarea id="text" placeholder="Type an instruction…"></textarea>
            <button id="send" title="Enter to send, Shift+Enter for newline">Send</button>
          </div>
        </main>
      </div>
    </div>

    <script>
      const log = document.getElementById('log');
      const text = document.getElementById('text');
      const send = document.getElementById('send');
      const statusEl = document.getElementById('status');
      const sidebar = document.getElementById('sidebar');
      const navToggleBtn = document.getElementById('navToggle');
      const sessionsEl = document.getElementById('sessions');
      const projectsEl = document.getElementById('projects');
      const openSettingsLink = document.getElementById('openSettings');
      const openMemoryLink = document.getElementById('showMemories');
      const icoSessions = document.getElementById('icoSessions');
      const icoProjects = document.getElementById('icoProjects');
      const icoMemory = document.getElementById('icoMemory');
      const icoSettings = document.getElementById('icoSettings');
      const themeToggleHeader = document.getElementById('themeToggleHeader');
      const connDot = document.getElementById('connDot');

      // Modal state
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="dialog">
          <h4 id="modalTitle">Confirm removal</h4>
          <p id="modalText">Are you sure?</p>
          <div class="actions">
            <button id="cancelBtn">Cancel</button>
            <button id="confirmBtn">Remove</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      const modalText = modal.querySelector('#modalText');
      const confirmBtn = modal.querySelector('#confirmBtn');
      const cancelBtn = modal.querySelector('#cancelBtn');
      let pendingAction = null;
      function openModal(text, action){ modalText.textContent = text; pendingAction = action; modal.classList.add('open'); }
      function closeModal(){ modal.classList.remove('open'); pendingAction = null; }
      cancelBtn.addEventListener('click', closeModal);
      confirmBtn.addEventListener('click', async ()=>{ if (pendingAction) { await pendingAction(); } closeModal(); });

      function addBubble(html, cls = '') {
        const el = document.createElement('div');
        el.className = `bubble ${cls}`;
        el.innerHTML = html;
        log.appendChild(el);
        log.scrollTop = log.scrollHeight;
      }

      function fmtTime(ms){ try{ return new Date(ms).toLocaleString(); } catch { return ''; } }
      function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;'); }

      function fmtTime12(ms){
        try {
          const d = new Date(ms);
          return d.toLocaleString('en-US', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
        } catch { return ''; }
      }

      function toKB(bytes){ try { return Math.max(1, Math.round((bytes||0)/1024)); } catch { return 0; } }

      async function loadSessions(){
        try {
          const r = await fetch('/sessions'); const { sessions, current } = await r.json();
          sessionsEl.innerHTML = '';
          sessions.forEach(s => {
            const a = document.createElement('a');
            const label = `${fmtTime12(s.mtimeMs)} — ${toKB(s.size)} KB`;
            a.href = '#'; a.innerHTML = `<div>${escapeHtml(label)}</div>`;
            if (current && s.path === current) a.style.borderColor = '#2b6ef6';
            a.addEventListener('click', async (e)=>{e.preventDefault(); await fetch('/resume',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:s.path})}); await loadTranscript();});
            a.addEventListener('contextmenu', (e)=>{
              e.preventDefault();
              openModal('Delete this session file?', async ()=>{
                await fetch('/session', { method: 'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path: s.path }) });
                await loadSessions();
              });
            });
            sessionsEl.appendChild(a);
          });
        } catch {}
      }

      async function loadProjects(){
        try {
          const r = await fetch('/projects'); const { groups } = await r.json();
          projectsEl.innerHTML = '';
          Object.keys(groups||{}).forEach(workdir => {
            const group = groups[workdir] || [];
            if (!group.length) return;
            const e = group[0];
            const a = document.createElement('a'); a.href = '#';
            const parts = (workdir || '').split('/').filter(Boolean);
            const projectName = parts[parts.length - 1] || workdir || 'Project';
            a.innerHTML = `<div>${escapeHtml(projectName)}</div>`;
            a.addEventListener('click', async (ev)=>{ev.preventDefault(); await fetch('/resume',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:e.resume_path})}); await loadTranscript();});
            a.addEventListener('contextmenu', (ev)=>{
              ev.preventDefault();
              openModal('Remove this entry from project history?', async ()=>{
                await fetch('/project-history', { method: 'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ resume_path: e.resume_path }) });
                await loadProjects();
              });
            });
            projectsEl.appendChild(a);
          });
        } catch {}
      }

      // Memory modal (fullscreen-like)
      const memoryModal = document.createElement('div');
      memoryModal.className = 'modal';
      memoryModal.innerHTML = `
        <div class="dialog" style="width: 860px; max-width: 98vw; height: 84vh; display:flex; flex-direction:column;">
          <h4 style="margin-bottom:6px;">Memory</h4>
          <div id="memoryBody" style="flex:1; overflow:auto; padding:6px;"></div>
          <div class="actions">
            <button id="memoryClose">Close</button>
          </div>
        </div>`;
      document.body.appendChild(memoryModal);
      const memoryBody = memoryModal.querySelector('#memoryBody');
      const memoryClose = memoryModal.querySelector('#memoryClose');
      openMemoryLink.addEventListener('click', async (e)=>{
        e.preventDefault();
        try {
          const r = await fetch('/memory'); const { facts } = await r.json();
          memoryBody.innerHTML = '';
          (facts||[]).forEach(f => {
            const row = document.createElement('div');
            row.className = 'list';
            row.innerHTML = `<a href=\"#\" style=\"display:block\">${escapeHtml(f)}</a>`;
            const link = row.querySelector('a');
            link.addEventListener('contextmenu', (ev)=>{
              ev.preventDefault();
              openModal('Delete this memory fact?', async ()=>{
                await fetch('/memory', { method: 'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ fact: f }) });
                row.remove();
              });
            });
            memoryBody.appendChild(row);
          });
        } catch {}
        memoryModal.classList.add('open');
      });
      memoryClose.addEventListener('click', ()=> memoryModal.classList.remove('open'));

      function setSidebarCollapsed(collapsed){
        sidebar.classList.toggle('collapsed', collapsed);
        sidebar.classList.toggle('expanded', !collapsed);
        localStorage.setItem('sidebarCollapsed',''+(collapsed?1:0));
      }
      function toggleSidebar(){ setSidebarCollapsed(!sidebar.classList.contains('collapsed')); }
      const initCollapsed = localStorage.getItem('sidebarCollapsed') === '1';
      setSidebarCollapsed(initCollapsed);
      navToggleBtn.addEventListener('click', toggleSidebar);
      icoSessions.addEventListener('click', ()=>{ setSidebarCollapsed(false); loadSessions(); });
      icoProjects.addEventListener('click', ()=>{ setSidebarCollapsed(false); loadProjects(); });
      icoMemory.addEventListener('click', (e)=>{ e.preventDefault(); setSidebarCollapsed(false); openMemoryLink.click(); });
      icoSettings.addEventListener('click', (e)=>{ e.preventDefault(); setSidebarCollapsed(false); openSettingsLink.click(); });
      const openMemoryTop = document.getElementById('openMemoryTop');
      openMemoryTop.addEventListener('click', (e)=>{ e.preventDefault(); openMemoryLink.click(); });

      function applyTheme(t){ document.body.classList.toggle('light', t === 'light'); localStorage.setItem('theme', t); updateThemeIcon(); }
      function themeIconSVG(){
        const isLight = document.body.classList.contains('light');
        if (isLight) {
          return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 12.5A9 9 0 1 1 11.5 3 7 7 0 0 0 21 12.5z" stroke="currentColor" stroke-width="1.6"/></svg>';
        }
        return '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="1.6"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" stroke="currentColor" stroke-width="1.6"/></svg>';
      }
      function updateThemeIcon(){ if (themeToggleHeader) themeToggleHeader.innerHTML = themeIconSVG(); }
      const initialTheme = localStorage.getItem('theme') || 'dark';
      applyTheme(initialTheme);
      if (themeToggleHeader) themeToggleHeader.addEventListener('click', ()=>{ const next = document.body.classList.contains('light') ? 'dark' : 'light'; applyTheme(next); });

      let streamEl = null;
      let lastLoadedResumePath = null;
      async function loadTranscript(){
        try {
          const r = await fetch('/session-messages');
          const { messages } = await r.json();
          log.innerHTML = '';
          (messages||[]).forEach(m => {
            const klass = m.role === 'user' ? 'from-user' : 'from-agent';
            addBubble(`<div class=\"msg\">${(m.text||'').replace(/</g,'&lt;')}</div>`, klass);
          });
        } catch {}
      }

      function startStream() {
        const es = new EventSource('/events');
        es.addEventListener('open', () => { if (connDot) connDot.className = 'dot ok'; });
        es.addEventListener('status', ev => {
          try {
            const d = JSON.parse(ev.data);
            const resumed = d.resumed ? `Yes` : 'No';
            const codexRunning = d.codex_running ? 'Running' : 'Stopped';
            const sessionConfigured = d.session_configured ? 'Ready' : 'Starting';
            const meta = d.resume_meta || null;
            let name = '';
            if (meta) { name = `${fmtTime12(meta.mtimeMs)} — ${toKB(meta.size)} KB`; }
            
            // Update status text with more comprehensive info
            const statusParts = [];
            statusParts.push(`Codex: <strong>${codexRunning}</strong>`);
            if (d.codex_running) {
              statusParts.push(`Session: <strong>${sessionConfigured}</strong>`);
            }
            if (d.resumed) {
              statusParts.push(`Resumed: <strong>Yes</strong>${name ? ` — <span style=\"opacity:.8\">${escapeHtml(name)}</span>` : ''}`);
            }
            statusEl.innerHTML = statusParts.join(' | ');
            
            // Update connection dot based on Codex status
            if (connDot) {
              if (d.codex_running && d.session_configured) {
                connDot.className = 'dot ok';
              } else if (d.codex_running) {
                connDot.className = 'dot warn';
              } else {
                connDot.className = 'dot err';
              }
            }
            
            if (d.resume_path && d.resume_path !== lastLoadedResumePath) {
              lastLoadedResumePath = d.resume_path;
              loadTranscript();
            }
          } catch {}
        });
        es.addEventListener('system', ev => {
          addBubble(`<div class=\"mono sys\">${JSON.parse(ev.data).text}</div>`);
        });
        es.addEventListener('stderr', ev => {
          addBubble(`<div class=\"mono err\">${JSON.parse(ev.data).text}</div>`);
        });
        es.addEventListener('tool', ev => {
          const d = JSON.parse(ev.data);
          addBubble(`<div class=\"mono tool\">▶ ${d.name}: ${d.detail || ''}</div>`);
        });
        es.addEventListener('delta', ev => {
          const d = JSON.parse(ev.data);
          if (!streamEl) {
            streamEl = document.createElement('div');
            streamEl.className = 'bubble from-agent';
            streamEl.innerHTML = '<div class=\"msg\"></div>';
            log.appendChild(streamEl);
          }
          const inner = streamEl.querySelector('.msg');
          inner.textContent += d.text;
          log.scrollTop = log.scrollHeight;
        });
        es.addEventListener('message', ev => {
          const d = JSON.parse(ev.data);
          if (streamEl) {
            streamEl = null;
          } else {
            addBubble(`<div class=\"msg\">${d.text.replace(/</g,'&lt;')}</div>`, 'from-agent');
          }
        });
        es.addEventListener('error', () => {
          if (connDot) connDot.className = 'dot err';
          addBubble(`<div class=\"mono err\">SSE connection lost… reconnecting</div>`);
        });
      }

      async function sendMessage() {
        const t = text.value.trim();
        if (!t) return;
        addBubble(`<div class=\"msg\">${t.replace(/</g,'&lt;')}</div>`, 'from-user');
        text.value = '';
        await fetch('/message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: t }) });
      }

      send.addEventListener('click', sendMessage);
      text.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); text.focus(); }
      });

      // Settings modal
      const settingsModal = document.createElement('div');
      settingsModal.className = 'modal';
      settingsModal.innerHTML = `
        <div class="dialog" style="width: 760px; max-width: 98vw; height: 80vh; display:flex; flex-direction:column;">
          <h4 style="margin-bottom:6px;">Settings</h4>
          <div id="settingsBody" style="flex:1; overflow:auto;">
            <div style="display:grid; grid-template-columns: 200px 1fr; gap:10px; align-items:center; margin-bottom:10px;">
              <label>Model</label>
              <input id="cfgModel" style="width:100%; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;" placeholder="gpt-5" />
              <label>Approval policy</label>
              <select id="cfgApproval" style="width:100%; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;">
                <option value="never">never (auto-approve)</option>
                <option value="ask">ask</option>
              </select>
              <label>Web search</label>
              <select id="cfgSearch" style="width:100%; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;">
                <option value="false">disabled</option>
                <option value="true">enabled</option>
              </select>
              <label>Streamable shell</label>
              <select id="cfgShell" style="width:100%; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;">
                <option value="true">enabled</option>
                <option value="false">disabled</option>
              </select>
              <label>Sandbox mode</label>
              <input id="cfgSandbox" style="width:100%; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;" placeholder="danger-full-access" />
              <label>Extra instructions</label>
              <textarea id="cfgExtra" style="width:100%; min-height: 96px; padding:6px; border:1px solid #2a2b32; border-radius:6px; background:#0b0b0c; color:#eaeaea;" placeholder="Additional system instructions appended to the default"></textarea>
            </div>
          </div>
          <div class="actions">
            <button id="settingsCancel">Close</button>
            <button id="settingsRestart">Save & Restart</button>
            <button id="settingsSave">Save</button>
          </div>
        </div>`;
      document.body.appendChild(settingsModal);
      const settingsBody = settingsModal.querySelector('#settingsBody');
      const cfgModel = settingsModal.querySelector('#cfgModel');
      const cfgApproval = settingsModal.querySelector('#cfgApproval');
      const cfgSearch = settingsModal.querySelector('#cfgSearch');
      const cfgShell = settingsModal.querySelector('#cfgShell');
      const cfgSandbox = settingsModal.querySelector('#cfgSandbox');
      const cfgExtra = settingsModal.querySelector('#cfgExtra');
      const settingsCancel = settingsModal.querySelector('#settingsCancel');
      const settingsSave = settingsModal.querySelector('#settingsSave');
      const settingsRestart = settingsModal.querySelector('#settingsRestart');
      openSettingsLink.addEventListener('click', async (e)=>{
        e.preventDefault();
        const r = await fetch('/config'); const cfg = await r.json();
        cfgModel.value = cfg.model || '';
        cfgApproval.value = cfg.approval_policy || 'never';
        cfgSearch.value = String(cfg['tools.web_search_request'] === true);
        cfgShell.value = String(cfg['use_streamable_shell'] !== false);
        cfgSandbox.value = cfg.sandbox_mode || 'danger-full-access';
        cfgExtra.value = cfg.instructions_extra || '';
        settingsModal.classList.add('open');
      });
      settingsCancel.addEventListener('click', ()=> settingsModal.classList.remove('open'));
      settingsSave.addEventListener('click', async ()=>{
        const payload = {
          model: cfgModel.value || 'gpt-5',
          approval_policy: cfgApproval.value,
          'tools.web_search_request': cfgSearch.value === 'true',
          use_streamable_shell: cfgShell.value === 'true',
          sandbox_mode: cfgSandbox.value || 'danger-full-access',
          instructions_extra: cfgExtra.value || ''
        };
        await fetch('/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        settingsModal.classList.remove('open');
      });
      settingsRestart.addEventListener('click', async ()=>{
        await settingsSave.click();
        await fetch('/restart', { method:'POST' });
      });

      // initial data
      async function loadTranscript(){
        try {
          const r = await fetch('/session-messages');
          const { messages } = await r.json();
          log.innerHTML = '';
          (messages||[]).forEach(m => {
            const klass = m.role === 'user' ? 'from-user' : 'from-agent';
            addBubble(`<div class=\"msg\">${(m.text||'').replace(/</g,'&lt;')}</div>`, klass);
          });
        } catch {}
      }
      loadSessions();
      loadProjects();
      document.addEventListener('DOMContentLoaded', ()=> document.body.classList.add('ready'));
      startStream();

    </script>
  </body>
</html>